---
interface Props {
  date: string;
  displayDate: string;
  theme?: string;
  music?: { name: string; time: string };
}

const { date, displayDate, theme, music } = Astro.props;
---

<div class="shareable-card-container">
  <canvas id="market-card-canvas" width="1080" height="1080" class="hidden"></canvas>

  <!-- Preview - Kinderhook illustrated style -->
  <div id="card-preview" class="bg-[#7ECBD6] rounded-2xl p-6 text-center max-w-sm mx-auto shadow-lg relative overflow-hidden">
    <!-- Decorative elements -->
    <div class="absolute top-3 left-3 text-2xl">ğŸ¥•</div>
    <div class="absolute top-3 right-3 text-2xl">ğŸŒ·</div>
    <div class="absolute top-12 left-1/4 text-xl">ğŸ¥¬</div>
    <div class="absolute top-10 right-1/4 text-xl">ğŸ…</div>
    <div class="absolute bottom-4 left-4 text-xl">ğŸŒ½</div>
    <div class="absolute bottom-4 right-4 text-xl">ğŸšœ</div>
    <div class="absolute bottom-12 left-1/4 text-lg">ğŸ</div>
    <div class="absolute bottom-10 right-1/4 text-lg">ğŸŒ»</div>

    <!-- Main content bubble -->
    <div class="bg-white rounded-[2rem] p-6 mb-4 relative">
      <p class="text-[#F26A2A] text-xs font-bold uppercase tracking-wider mb-1">You're Invited!</p>
      <h3 class="font-display font-bold text-2xl text-black leading-tight">KINDERHOOK</h3>
      <h3 class="font-display font-bold text-lg text-black mb-2">Farmers' Market</h3>

      <!-- Date bubble -->
      <div class="bg-[#F26A2A] text-white rounded-full py-2 px-4 inline-block mb-2">
        <p class="font-display font-bold text-sm">{displayDate}</p>
      </div>
      <p class="text-black/70 text-sm">8:30 AM - 12:30 PM</p>
    </div>

    <!-- Theme/Music bubble -->
    {(theme || music) && (
      <div class="bg-white rounded-2xl p-4 mb-4">
        {theme && <p class="font-display font-bold text-[#F26A2A]">{theme}</p>}
        {music && <p class="text-black/70 text-sm">ğŸµ {music.name}</p>}
      </div>
    )}

    <!-- Location -->
    <p class="text-white text-sm font-medium">Village Green, Broad Street</p>
    <p class="text-white/80 text-xs">Kinderhook, NY</p>

    <!-- It's OK badge -->
    <div class="inline-block bg-black text-white text-xs font-bold px-3 py-1 rounded-full mt-3">
      It's OK!
    </div>
  </div>

  <div class="text-center">
    <button
      id="download-card-btn"
      class="mt-6 inline-flex items-center gap-2 bg-orange text-white font-display font-bold px-6 py-3 rounded-full hover:bg-orange/90 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
      </svg>
      Save & Share
    </button>
    <p class="text-black/50 text-sm mt-2">Opens share sheet on mobile, downloads on desktop</p>
  </div>
</div>

<script define:vars={{ date, displayDate, theme, music }}>
  const canvas = document.getElementById('market-card-canvas');
  const ctx = canvas.getContext('2d');
  const downloadBtn = document.getElementById('download-card-btn');

  function generateCard() {
    const width = 1080;
    const height = 1080;

    // Light teal/blue background (like the Kinderhook map)
    ctx.fillStyle = '#7ECBD6';
    ctx.fillRect(0, 0, width, height);

    // Draw decorative illustrations
    drawDecorations();

    // Main white bubble
    ctx.fillStyle = 'white';
    drawBubble(140, 120, 800, 520, 60);
    ctx.fill();

    // "You're Invited"
    ctx.textAlign = 'center';
    ctx.fillStyle = '#F26A2A';
    ctx.font = 'bold 28px Inter, sans-serif';
    ctx.fillText("YOU'RE INVITED!", width / 2, 200);

    // "KINDERHOOK"
    ctx.fillStyle = '#1A1A1A';
    ctx.font = 'bold 90px Nunito, sans-serif';
    ctx.fillText('KINDERHOOK', width / 2, 310);

    // "Farmers' Market"
    ctx.font = 'bold 50px Nunito, sans-serif';
    ctx.fillText("Farmers' Market", width / 2, 380);

    // Orange date pill
    ctx.fillStyle = '#F26A2A';
    roundRect(ctx, 240, 420, 600, 70, 35);
    ctx.fill();

    ctx.fillStyle = 'white';
    ctx.font = 'bold 32px Nunito, sans-serif';
    ctx.fillText(displayDate, width / 2, 465);

    // Time
    ctx.fillStyle = '#1A1A1A';
    ctx.font = '400 32px Inter, sans-serif';
    ctx.fillText('8:30 AM - 12:30 PM', width / 2, 560);

    // Theme/Music bubble (if exists)
    let yOffset = 680;
    if (theme || music) {
      ctx.fillStyle = 'white';
      drawBubble(240, 640, 600, theme && music ? 140 : 100, 30);
      ctx.fill();

      if (theme) {
        ctx.fillStyle = '#F26A2A';
        ctx.font = 'bold 36px Nunito, sans-serif';
        ctx.fillText(theme, width / 2, 705);
        yOffset = 750;
      }
      if (music) {
        ctx.fillStyle = '#1A1A1A';
        ctx.font = '400 28px Inter, sans-serif';
        ctx.fillText(`ğŸµ ${music.name}`, width / 2, theme ? 750 : 705);
        yOffset = theme ? 820 : 770;
      }
    }

    // Location
    ctx.fillStyle = 'white';
    ctx.font = '500 28px Inter, sans-serif';
    ctx.fillText('Village Green, Broad Street', width / 2, 880);
    ctx.font = '400 24px Inter, sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.fillText('Kinderhook, NY', width / 2, 920);

    // "It's OK!" badge
    ctx.fillStyle = '#1A1A1A';
    roundRect(ctx, width / 2 - 70, 960, 140, 50, 25);
    ctx.fill();
    ctx.fillStyle = 'white';
    ctx.font = 'bold 24px Nunito, sans-serif';
    ctx.fillText("It's OK!", width / 2, 993);
  }

  function drawDecorations() {
    // Draw veggie/farm illustrations around the edges
    ctx.font = '70px serif';
    // Top corners
    ctx.fillText('ğŸ¥•', 60, 100);
    ctx.fillText('ğŸŒ·', 940, 100);
    // Top middle area
    ctx.fillText('ğŸ¥¬', 250, 80);
    ctx.fillText('ğŸ…', 780, 90);
    // Middle sides
    ctx.fillText('ğŸŒ»', 50, 500);
    ctx.fillText('ğŸ', 960, 500);
    // Bottom area
    ctx.fillText('ğŸŒ½', 80, 980);
    ctx.fillText('ğŸšœ', 920, 980);
    ctx.font = '50px serif';
    ctx.fillText('ğŸ«‘', 200, 1010);
    ctx.fillText('ğŸ¥’', 830, 1000);
  }

  function drawBubble(x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }

  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }

  downloadBtn.addEventListener('click', async () => {
    generateCard();

    const filename = `kinderhook-market-${date}.png`;

    // Convert canvas to blob for sharing
    canvas.toBlob(async (blob) => {
      if (!blob) return;

      const file = new File([blob], filename, { type: 'image/png' });

      // Try native share (mobile - allows save to photos)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'Kinderhook Farmers Market',
            text: `Join us at the Kinderhook Farmers' Market - ${displayDate}!`
          });
          return;
        } catch (err) {
          // User cancelled or share failed, fall back to download
          if (err.name === 'AbortError') return;
        }
      }

      // Fallback: regular download
      const link = document.createElement('a');
      link.download = filename;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    }, 'image/png');
  });
</script>
